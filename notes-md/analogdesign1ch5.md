# Operational Amplifiers with Single-Ended Outputs
一般而言，规定理想的单端运算放大器为具有差分输入，无限增益，无限输入阻抗，0输出阻抗，其本身作为一种模拟运算单元工作于集成电路中，通常是电压放大器，实际上我们不直接使用放大器本身的特性，如它的增益，我们通过环路来控制其特性以满足运算的功能，故称为运算放大器。
##  运放的应用
关于反馈的部分，这里不进行介绍，后面会单独出一章详细解释，在分析时，只需要注意在运放输入端的虚短与虚断（即两个输入点的电压一致，称为虚短，两个输入点的电流为0，称为虚断），英文中称为**summing-point constraint**，当然这个假设前提是开环增益a足够大。

下图展示了几个具有反馈回路的运算放大器
<div align="middle"><img src="./pic/analog_ic_gray/pic_6.3.png " width=450 alt="图6.3"></div>

第一个（a）是反向放大器，取开环增益为a，并将其考虑在内，取X点的KCL：
$$
\frac{V_s-V_i}{R_1}+\frac{V_o-V_i}{R_2}=0 \\
V_i=\frac{-V_o}{a} \\
=> \frac{V_o}{V_i}=-\frac{R_2}{R_1}\left[\frac{1}{1+\frac{1}{a}\left(1+\frac{R_2}{R_1}\right)}\right]
$$
当$a\left(\frac{R_1}{R_1+R_2}\right) \gg 1$时，闭环增益有$\frac{V_o}{V_s}\simeq -\frac{R_2}{R_1}$
其中$V_i=\frac{-V_o}{a}$，当输出值为有限值得时候，a如果很大，可以认为$V_i$为零，这个等式有一个隐含的条件就是电路的反馈为负反馈，且电路工作在稳定点。

第二个（b）是同向放大器，同样取开环增益为a，$V_i=V_o/a$,在X点有KCL：
$$
V_x=V_o\left(\frac{R_1}{R_1+R_2}\right)=V_s-\frac{V_i}{a} \\
=>\frac{V_o}{V_s}\simeq\left(1+\frac{R_2}{R_1}\right)
$$
这个近似结果成立于$aR_1/(R_1+R_2)\gg 1$。而在$R_1\to \infty,R_2\to 0$时，变为电压跟随器，即第三个（c）所示。

需要注意的是这两个放大电路的区别，同相放大器的输入阻抗很明显远大于反相放大器的输入阻抗，且同相放大器的输入$V_s$直接等于放大器的输入$V_i$，这与反相放大器的不同，体现在输入共模范围上。
<div align="middle"><img src="./pic/analog_ic_gray/pic_6.4.png " width=450 alt="图6.4"></div>
第四个展示的是差分放大器，即将两个输入的差值进行放大的电路。

直接给出传递函数：$V_o=\frac{R_2}{R_1}(V_1-V_2)$

这种差分放大器通常需要检测和放大两个较大电压之间的微小差值。例如，典型的应用是测量惠斯通电桥两臂之间的差分电压。其共模输入如同同相放大器当$R_2\gg R_1$时一样为$(V_1+V_2)/2$。
<div align="middle"><img src="./pic/analog_ic_gray/pic_6.5.png " width=450 alt="图6.5"></div>

上图是非线性放大器中的对数放大器，其广泛运用于大动态范围输入的检测和运算，取虚断虚短假设，那么输入的$V_s$由电阻R转换为电流进入反馈的三极管，同时由于虚短，三极管的$V_{CB}=0$那么其工作于正向有源区，则基-射压差与集电极电流呈对数关系。有：
$$
I_1=\frac{V_s}{R}=I_c=I_S\left[exp\left(\frac{V_{be}}{V_T}\right)-1\right]\simeq I_Sexp\left(\frac{V_{be}}{V_T}\right) \\
V_o=-V_{be}  \\
=>V_o=-V_Tln\left(\frac{V_s}{I_SR}\right)
$$
可以用这个方法得到诸多非线性的放大器，举个例子：将两个信号通过该电路取log然后相加，再通过反相放大器中将$R_1$换为二极管就得到指数输出，总体而言就是两个信号的相乘。其他非线性运算，如限幅、整流、峰值检测、平方、平方根、幂级数和除法等，都可以用概念上类似的方法进行。

<div align="middle"><img src="./pic/analog_ic_gray/pic_6.6.png " width=450 alt="图6.6"></div>

上图所展示的是积分器以及微分器，公式如下：

对于积分器：
$$
I_1=\frac{V_s}{R}=I_2 \\
V_o=-\frac{1}{C}\int_0^tI_2d\tau+V_o(0) \\
=>V_o(t)=-\frac{1}{RC}\int_0^tV_s(t)d\tau+V_o(0)
$$
对于微分器：
$$
I_1=C\frac{dV_s(t)}{dt}=I_2 \\
V_o(t)=-I_2R=-RC\frac{dV_s(t)}{dt}
$$
在介绍后面的放大器之前，我们先介绍内部放大器的概念：在单片的模拟系统中，如ADC，滤波器，PLL中，其内部的运放的性能和独立封装，通用的运放，如LM741，OPA2134不同。在芯片内部，大多数运放只驱动内部的已知节点，他们的输出节点通常是已知的较小的纯容性节点，它们称为*内部运放(internal amplifiers)*，还有一小部分用于将信号输出到外界，而他们的输出则可能是较大且不确定的阻性或容性负载，它们称为*输出缓冲(output buffers)*，而独立的通用运放则可能面对更加严苛的负载条件，如几百pF的容性负载或者2k$\Omega$的阻性负载。

在MOS工艺中，电容常常是反馈回路的元件，因为其在工艺中相比电阻精度高，此外其dc开路特性降低了静态功耗，配合MOS开关可以做到离散的信号处理，进而进行如积分，滤波等行为。
<div align="middle"><img src="./pic/analog_ic_gray/pic_6.7.png " width=450 alt="图6.7"></div>

上图所示的就是一个使用电容作为反馈回路的反相放大器，其传递函数很容易得知为$V_o/V_s=-C_1/C_2$，但这个电路有个问题，由于在dc时电容的阻抗为无穷大，导致输入点的电位浮空，即没有偏置，故而引入开关电容电路

<div align="middle"><img src="./pic/analog_ic_gray/pic_6.8.png " width=450 alt="图6.8"></div>

图中的开关由MOS管构成，且由两个互不重合的时钟信号控制，以防止节点同时被多个电源控制，当$\phi_1$高电平时如图C所示，这个阶段输入电压源向$C_1$充电，$C_2$两端接地，这个阶段称为采样阶段，总电荷为：
$$
 Q_1=(0-V_s)C_1+(0)C_2=-V_sC_1 
$$
而在$\phi_2$为高电平时，$C_1$两端为地（一端在放大器为理想时为虚拟地），而$C_2$一端为输出电压，一端为地，这个阶段称为电荷转移阶段，有：
$$
 Q_2=(0)C_1+(0-V_o)C_2=-V_oC_2 
$$
假设在这个过程中电荷守恒$Q_1=Q_2$，则有传递函数：
$$
 V_o/V_s=C_1/C_2 
$$
需要注意的几点是：第一，$V_s$和$V_o$指代的是$\phi_1$和$\phi_2$高电平结束时的电压值，实际的波形并不如这个传递函数所示，因为涉及到电荷的转移即电容的充放电，那么$Q_1,Q_2$实际上除了受到输入电压的影响还受到充电放电时间的影响和放大器带宽以及MOS开关电阻大小的影响。而只要保证$\phi_1$和$\phi_2$的时间够长，就能保证充电和放电的完整。第二，转递函数为正，是由于在输入电压$V_s$为正时，$C_1$在输入电压端为正，放大器输入端为负，在转移阶段，由于电压差为0，开始放电，负电荷移动到$C_2$的放大器输入端，在输出端产生正电荷，进而相比地位（放大器输入端）为正电荷，Gary的解释为，由于电荷转移阶段$C_1$上的正电压放电为负变化，在反相放大的作用下变为正相输出。 

MOS工艺极好的适配构建开关电容电路有两个主要的原因：
- 第一，零输入电流，连接至MOS管栅极不存在dc电流，进而没有参与电容的充放电干扰，这对于$\beta_F$为有限值的bipolar是做不到的。
- 第二，零偏差开关，对于MOS管而言，其漏极以及源极是可以互换的，在栅极的控制信号电位取高电平与低电平时(在以前的电路中采用双电轨即$-V_{SS}$和$V_{DD}$，现在减小了电源电压之后取GND和$V_{DD}$)，其余电路中节点电压不高于高电平和且不低于低电平（这一点总是成立），当$\phi$取低电平时，能直接关断MOS管，而当$\phi$取高时，只要节点电压不高于高电位减去一个阈值电压，那么MOS管就能打开，且随着电容充电，dc电流逐渐降为0，MOS开关也工作于三极管区（线性区），当电流为0时，漏源电压差也为0，能保证输入电压零偏差的传递到开关另一端，这是MOS作为开关的重要原因，这一点bipolar是做不到的，因为当bipolar的集电极-发射极电流为零时，仍然可以存在压差。

<div align="middle"><img src="./pic/analog_ic_gray/pic_6.9.png " width=450 alt="图6.9"></div>

用上图所示的开关电容放大器解释为什么这种放大器对于寄生电容不敏感，在放大器负输入端引入$C_P$作为该点的所有可能寄生电容，由于增益取决于放大器输入节点的电荷量，故其他点的寄生电容不影响增益（但会影响最大时钟频率），而输入节点的寄生电容对于电路增益的影响误差反比于运放的开环增益。

我们依然用开环增益a来表示输入节点的电压而不是虚短来表示，在采样阶段的电荷不变，$Q_1=(0-V_s)C_1+(0)C_2=-V_sC_1$，而在电荷转移阶段引入寄生电容对于电荷的重分布：

$$
 Q_2=\left(-\frac{V_o}{a}\right)C_1+\left(-\frac{V_o}{a}\right)C_P+\left(-\frac{V_o}{a}-V_o\right)C_2 
$$
有：
$$
 \frac{V_o}{V_s}=\frac{C_1}{C_2}\left[\frac{1}{1+\frac{1}{a}\left(\frac{C_2}{C_1+C_2+C_P}\right)}\right] 
$$
得到：
$$
 \frac{V_o}{V_s}=\frac{C_1}{C_2}(1-\epsilon) 
$$
其中
$$
 \epsilon=\frac{1}{1+\frac{1}{a}\left(\frac{C_2}{C_1+C_2+C_P} \right)} 
$$
可以看出来，当$a\to \infty$时，$\epsilon \to 0$，传递的结果也就越趋近于$C_1/C_2$，故而称这个电路为*寄生不敏感(parastic insensitive)*
## 基础二级运放
接下来介绍的二级运放为最基础的五管OTA加上共源级配合补偿电容（或有必要则加入调零组件）的二级运放，虽然结构简单，但能提供好的输入摆幅，直流增益，PSRR，CMRR。
<div align="middle"><img src="./pic/analog_ic_gray/pic_6.16.png " width=450 alt="图6.16"></div>

### 输入阻抗，输出阻抗，电压增益
由于输入于pmos的栅极，故低频的输入阻抗为无穷大。输出阻抗为M6和M7的小信号输出阻抗并联$R_o=r_{o6}\parallel r_{o7}$。

电压增益$A_v=A_{v1}A_{v2}$，其中$A_{v1},A_{v2}$分别为第一级电压增益和第二级电压增益，有：
$$
A_{v1}=G_{m1}R_{o1}=g_{m1}(r_{o4}\parallel r_{o2}) \\
A_{v2}=-g_{m6}(r_{o6}\parallel r_{o7}) \\
A_{v}=-g_{m1}g_{m6}(r_{o4}\parallel r_{o2})(r_{o6}\parallel r_{o7})
$$
可见这个增益的数量级为$(g_mr_o)^2$级别，MOS的本征增益有$g_mr_o=\frac{2V_A}{V_{ov}}$，其中$V_A$受MOS管的长度影响，$V_{ov}$受偏置条件影响。
### 输出摆幅
输出摆幅定义为在输出电压$V_o=V_O+v_o$发生变化时，所有的晶体管能正常工作在饱和区的区间值，可以很容易通过电路得知：
$$
 -V_{SS}+V_{ov6}<V_o<V_{DD}-|V_{ov7}| 
$$
### 输入失调电压
之前提及的输入失调电压指的是在差分输出电压为零时的差分输入电压值，由于这里只有一个输出，故稍作修改，改为输出电压相对地的电压差为零时的差分输入电压。当然这个定义有意义的前提是$V_{DD}=|V_{SS}|$且$V_{ov6}=|V_{ov7}|$，这个前提保证了在输出电压为零时输出摆幅最大，如果$V_{DD}\ne |V_{SS}|$，那么就取中间值作为参考点以满足最大摆幅。

输入失调电压由两部分组成，一部分为系统失调电压，由电路设计本身造成，与工艺和不对称无关，一部分为随机失调电压，由不对称与失配造成。

#### 系统失调电压
假设电路完全对称，不存在失配，那么由于$I_{d3}=I_{d4}$，那么则有$V_{GS3}=V_{GS4}$，由于M3是二极管连接，有$V_{ds3}=V_{gs3}$，同时由于完全对称，所以$V_{DS4}=V_{DS3}=V_{GS4}=V_{GS3}$。

为了使输出电压工作在0，那么M6和M7的漏电流就需要相等以保持平衡，由于连接关系，有$V_{DS4}=V_{GS6}$，假设$V_{t3}=V_{t4}=V_{t6}$，那么有：
$$
V_{ov3}=V_{ov4}=V_{ov6} \\
\frac{I_{DS3}}{(W/L)_3}=\frac{I_{DS4}}{(W/L)_4}=\frac{I_{DS6}}{(W/L)_6} \\
$$
结合电流关系：$I_{DS3}=I_{DS4}=|I_{DS5}|/2$，以及电流镜关系：$I_{DS5}/I_{DS7}=(W/L)_5/(W/L)_7$有：
$$
 \frac{(W/L)_3}{(W/L)_6}=\frac{(W/L)_4}{(W/L)_6}=\frac{1}{2}\frac{(W/L)_5}{(W/L)_7} 
$$
在前面的假设情况中，可以得到输出电压为：
$$
 V_O=V_{DS6}-V_{SS}=V_{ov3}+V_{t3}-V_{SS} 
$$
那么根据输入失调电压定义可得：
$$
 V_{OS(sys)}=\frac{\frac{V_{DD}-V_{SS}}{2}-(V_{t3}+V_{ov3}-V_{SS})}{A_v} 
$$
尽管这个值在绝大多数情况不为零，但可以通过在宽长比选择以及版图绘制时减少其受工艺的影响，原理就是通过设置最小MOS管单元，然后根据比例重复这些单元以实现前文中M3，M4，M5，M6，M7的比例关系。

*实际上，对于匹配器件，沟道长度几乎从不直接配比，因为高速工作时使用较小的沟道长度会导致对工艺变化的较大敏感性。另一方面，如果匹配器件的沟道宽度足够大，从而对工艺变化的敏感性不明显，则有时会直接进行配比。本分析的一个关键点是，M3、M4 和 M6 使用相同的沟道长度与其他要求相冲突。首先，出于稳定性原因，M6 应具有较大的跨导，因此通道长度较短。其次，为了获得低噪声和随机输入失调电压，M3 和 M4 的跨导应较小，因此通道长度应较长。*

#### 随机失调电压
随机失调电压的公式之前以及给出过，这里进行重复：
$$
 V_{OS}\simeq \Delta V_{t(1-2)}+\Delta V_{t(3-4)}\frac{g_{m3}}{g_{m1}}+\frac{V_{ov(1-2)}}{2}\left[\frac{\Delta \left(\frac{W}{L} \right)_{(3-4)}}{\left(\frac{W}{L} \right)_{(3-4)}}-\frac{\Delta \left(\frac{W}{L} \right)_{(1-2)}}{\left(\frac{W}{L} \right)_{(1-2)}} \right] 
$$
通过这个公式可以分析得到减小随机失调电压的方法：第一项是输入对管的阈值电压差，第二项是负载电流镜管的阈值电压差，可以选择较小的$(W/L)$来使得其跨导小于输入对管的跨导，可以为M3 M4选择更长的沟道长度，第三项是输入对管和负载管的宽长失配，可以通过控制输入对管的过驱动电压较小使得其变小，如50mV~200mV。

### 输入电压范围
所谓输入电压范围就是输入电压能保证电路正常工作的范围，分析比较简单，上界就是从上电源出发找一条最长的压降到输入，下界就是从下电源出发找一条最长的压升到输入。这里给出这个电路的输入摆幅：
$$
 -V_{SS}+V_{t3}+V_{ov3}-|V_{t1}|<V_{IC}<V_{DD}-|V_{ov5}|-|V_{ov1}|-|V_{t1}| 
$$
不过需要额外提一嘴的是阈值电压受到体效应的影响进而会对输入摆幅产生影响。假如M1 M2的衬底连接至$V_{DD}$，那么当输入较高时，$|V_{SB}|$较小，对阈值电压影响较小，故摆幅的上界可以用零偏时的阈值电压近似，当输入较低时，$|V_{SB}|$较大，对阈值电压影响较大，故在考虑下界时，可以将体效应纳入考虑。

### CMRR
这个单输出的二级运放的CMRR，仅须考虑第一级的影响即可，因为第二级是单输入单输出，对CMRR不产生贡献，这是因为CMRR的定义是输入共模信号到输出的差分增益比差分信号到差分输出的增益，而单端输入单端输出并没有共模差模的定义。

根据定义有：
$$
 CMRR=\left|\frac{A_{dm}}{A_{cm}}\right|=\left|\frac{\frac{v_o}{v_{o1}}\frac{v_{o1}}{v_{id}}}{\frac{v_o}{v_{o1}}\frac{v_{o1}}{v_{ic}}}\right|=CMRR_1 
$$
可得：

$$
 CMRR\simeq(2g_{m(dp)}r_{(tail)})g_{m(mir)}(r_{o(dp)}\parallel r_{o(mir)}) \\
\simeq \left|\frac{2}{V_{ov(dp)}}\frac{2}{V_{ov(mir)}}\frac{1}{V_{A(tail)}}\left(\frac{V_{A(dp)}V_{A(mir)}}{|V_{A(dp)}|+|V_{A(mir)}|} \right)\right|
$$

(gary书上式子有误，缺少了尾电流阻抗部分)

其中$g_{m(dp)}$和$r_{o(dp)},V_{A(dp)},V_{ov(dp)}$为输入管的跨导、小信号阻抗、厄利电压和过驱动电压，$r_{tail},V_{A(tail)}$为尾电流管M5的小信号阻抗和厄利电压，$g_{m(mir)},r_{o(mir)},V_{ov(mir)},V_{A(mir)}$分别为负载电流镜的跨导，小信号阻抗，过驱动电压以及厄利电压。可以看出，可以通过减小过驱动电压来增大CMRR，或者用高阻抗的电流镜结构在M5上，不过代价是牺牲输入电压裕度。

### PSRR
对于PSRR+，其计算公式为$PSRR^+=\frac{A_v}{A^+}$，其中$A^+=v_o/v_{dd}$
<div align="middle"><img src="./pic/analog_ic_gray/pic_6.16.png " width=450 alt="图6.16"></div>

由于M8 M5 M7都是$I_{BIAS}$的倍数，故而认为它们的$v_{gs8}=v_{gs5}=v_{gs7}=0$，也就导致它们的受控源不参与小信号分析，只有输出阻抗参与分析，如下图所示：
<div align="middle"><img src="./pic/analog_ic_gray/pic_6.18.png " width=450 alt="图6.18"></div>

在计算PSRR+时为了便于分析，将$v_{dd}$的施加分为两部分，一部分加在第一级尾电流源的源极，一部分加在第二级负载管的源极，在施加其中一个$v_{dd}$时，其他的电压源接地，包括另一个$v_{dd}$，定义加在第二级负载管的源极的$v_{dd}$在输出级产生的小信号输出电压为$v_{oa}$，定义加在第一级尾电流源的源极的$v_{dd}$在输出级产生的小信号输出电压为$v_{ob}$，根据叠加定理，有$v_o/v_{dd}=(v_{oa}+v_{ob})/v_{dd}$。

对于（a）图，也就是$v_{oa}$，由于第一级没有输入，也就没有输出变化到第二级，导致$v_{gs6}=0$，故M6的受控源也失效，第二级施加的$v_{dd}$到输出仅受M6 M7输出阻抗的分压，即：
$$
 \frac{v_{oa}}{v_{dd}}=\frac{r_{o6}}{r_{o6}+r_{o7}}=\frac{\frac{V_{A6}}{I_{D6}}}{\frac{V_{A6}}{I_{D6}}+\frac{|V_{A7}|}{I_{D6}}}=\frac{V_{A6}}{V_{A6}+|V_{A7}|} 
$$

对于（b）图，也就是$v_{ob}$，有：
$$
 \frac{v_{ob}}{v_{dd}}=\frac{v_{gs6}}{v_{dd}}\frac{v_{ob}}{v_{gs6}} 
$$
其中第一项代表当其他电源接地，施加信号在$r_{tail}$的顶端和地端之间，这种情况就是源极添加退化电阻的共栅级的情况，但其也可以等效为源极退化的共源级，也就是可以等效施加信号在M1 M2的栅端和地之间，不过极性相反，这种情况也是共模输入的情况，也就是$v_{dd}=-v_{ic}$，进而有：
$$
 \frac{v_{gs6}}{v_{dd}}=-\frac{v_{gs6}}{v_{ic}}=-G_{m}[cm]R_{o1} 
$$
其中对于$G_{m}[cm]$的定义以及详细计算可以参考[CMRR](#cmrr)：
$$
\frac{v_{gs6}}{v_{dd}}\simeq \frac{g_{m(dp)}}{1+2g_{m(dp)}r_{tail}}\left(\frac{1}{1+g_{m(mir)}r_{o(dp)}}+\frac{1}{1+g_{m(mir)}r_{o(mir)}}\right)(r_{o(dp)}\parallel r_{o(mir)})
$$
取本征增益近似：$g_{m(dp)}r_{tail}\gg 1,g_{m(mir)}r_{o(dp)}\gg 1,g_{m(mir)}r_{o(mir)}\gg 1$，得到近似结果：
$$
 \frac{v_{gs6}}{v_{dd}}\simeq \frac{r_{o(dp)}\parallel r_{o(mir)}}{2r_{tail}g_{m(mir)}(r_{o(dp)}\parallel r_{o(mir)})}=\frac{1}{2g_{m(mir)}r_{tail}} 
$$
那么对于整个电路有：
$$
 \frac{v_{ob}}{v_{dd}}\simeq -\frac{g_{m6}(r_{o6}\parallel r_{o7})}{2g_{m(mir)}r_{tail}} 
$$
如果在控制系统偏差的要求下使得$V_{ov3}=V_{ov6}$，便会有：$g_{m6}/g_{m(mir)}=I_{D6}/I_{D3}$，同时，有$V_{A5}=V_{A7}$以及$I_{D5}=2|I_{D3}|$故有：
$$
 \frac{v_{ob}}{v_{dd}}\simeq-\frac{I_{D6}}{2I_{D3}}\left(\frac{\frac{V_{A6}}{I_{D6}}\frac{|V_{A7}|}{I_{D6}}}{\frac{V_{A6}}{I_{D6}}+\frac{|V_{A7}|}{I_{D6}}}\right)\frac{|I_{D5}|}{|V_{A5}|}=-\frac{|I_{D5}|}{2I_{D3}}\left(\frac{V_{A6}}{V_{A6}+|V_{A7}|}\right)\frac{|V_{A7}|}{|V_{A5}|}=-\frac{V_{A6}}{V_{A6}+V_{A7}} 
$$
故：
$$
 A^+=\frac{v_o}{v_{dd}}=\frac{v_{oa}+v_{ob}}{v_{dd}}\simeq 0 
$$
因此，在低频中，若电路完美匹配，有$PSRR^+\to \infty$，不过实际上会因为不对称的失调导致无法达到无穷大。

对于PSRR-，其计算公式为$PSRR^-=\frac{A_v}{A^-}$，其中$A^-=\frac{v_{o}}{v_{ss}}$，同样在$v_{ss}$端加入小信号，其他电压源接地进行计算。

对于电路的第一级，由于M1 M2处于共栅放大，两边被一样的偏置电流控制，而对于M3为二极管连接，导致其$v_{gs3}=0$，且$v_{gs3}=v_{ds3}=0$，同时由于对称性，导致$v_{ds4}=v_{ds3}=0$，进而使得$v_{ds4}=v_{gs6}=0$，从而导致M6的受控源失效，故在第二级呈现为一个简单的输出阻抗分压的模型，故有：
$$
 A^-=\frac{v_{o}}{v_{ss}}=\frac{r_{o7}}{r_{o6}+r_{o7}}=\frac{\frac{|V_{A7}|}{I_{D6}}}{\frac{V_{A6}}{I_{D6}}+\frac{|V_{A7}|}{I_{D6}}}=\frac{|V_{A7}|}{V_{A6}+|V_{A7}|} 
$$
代入$A_v$：
$$
 PSRR^-=\frac{A_v}{A^-}=\frac{\frac{v_o}{v_{v_{id}}}}{\frac{v_{o}}{v_{ss}}}=-\frac{2}{|V_{ov1}|}\frac{2}{V_{ov6}}\left(\frac{|V_{A2}|V_{A4}}{|V_{A2}|+V_{A4}}\right)V_{A6} 
$$


上式表示的是低频时的$PSRR^-$，随着频率增加会出现衰减，主要是由于补偿电容$C_c$在高频时呈现低阻抗通路，将M6的栅漏短路，由于$v_{gs6}$保持不变，使得地的信号直接馈通到输出点，进而增大了$A^-$，使得$PSRR^-$恶化。

#### PSR与电源电容
前面提及的情况都是在低频下电源端的小信号从运放内部到输出端的传递，但实际上还有一个路径会导致电源的信号馈通到输出点，就是通过电源电容，简单而言，就是在运放被外部电容$C_I$反馈工作时，由于电源电容，导致电源上的小信号馈通到输入端，进而再通过反馈电容传递到输出
<div align="middle"><img src="./pic/analog_ic_gray/pic_6.19.png " width=450 alt="图6.19"></div>

如上图所示，假设运放本身的开环增益为无穷大，由于电源电容的存在，使得从电源到输出的增益为$-C_{SUP}/C_{I}$，在上图中展示了两个电源电容的可能组成，即M1的$C_{gs1}$和$C_{gd1}$，接下来分析四种可能的方法导致电源电容的产生。
- M3导致的小信号馈通

前文提到，在地端加入小信号分析时，由于M3被恒电流偏置，导致$v_{ds3}=v_{gs3}=0$，但这也导致M1的漏端存在小信号变化，由于M1栅端接地，导致$C_{gd1}$作为电源电容将地噪声馈通到输入工作，这个问题可以通过在M1的漏端叠加cascode管进行削弱。
- 尾电流形成的小信号馈通

前文在分析尾电流源受到电源影响时，可以看出来尾电流源的电流明显会受到电源信号的影响，故尾电流提供的电流$I_{tail}$可以表示为$I_{tail}=i_{tail}+I_{TAIL}$
<div align="middle"><img src="./pic/analog_ic_gray/pic_6.20.png " width=450 alt="图6.20"></div>

将M1和尾电流源的小信号模型放在一起得到上图，其中M1处于类似于源极跟随器的模式，因为第一，M1的栅极由于反馈的存在被保持在地电位，第二，MOS管在有源区工作时，其电流取决于栅极和源极的电压差。那么可有上面的b图的小信号模型。对M1的源极取KCL有：
$$
i_{tail}+v_s-g_m(0-v_s)=0 \\
<=>v_s=\frac{i_{tail}r_o}{1+g_mr_o}\simeq \frac{i_{tail}}{g_m}
$$
可以看到源电压确实受尾电流的小信号变化影响，而这个变化会通过$C_{gs}$耦合到M1的输出端，进而影响输出，在这里，电源电容为$C_{SUP}=C_{gs}$，解决方法是使用一个电源独立的尾电流源即可。

<img src="E:\markdown_prj\pic\analog_ic_gray\pic_6.21.png" alt="pic_6.21" style="zoom:60%;" />

- 衬底效应的小信号馈通

电源产生的小信号会对衬底连接至电源的MOS管产生影响，M1作为输入p管，加入其衬底连接时$V_{dd}$，那么当上面产生小信号时，也会对衬底产生效应，进而改变阈值电压从而改变$v_{gs}$，小信号模型如上图（b）所示，假设这里的尾电流不发生变化，在源极列KCL有：
$$
\frac{v_s}{r_o}=g_m(0-v_s)+g_{mb}(v_{dd}-v_{s}) \\
<=>v_s=\frac{g_{mb}r_o}{1+(g_m+g_{mb})r_o}v_{dd}
$$
这份源级的电压变化也会通过$C_{gs}$馈通到栅极输入端，进而影响输出，所以在这里电源电压为$C_{SUP}=C_{gs}$。这个问题的解决方法可以通过井工艺解决，即为输入管单独放置在一个井中，其源端和衬底连接在一起。这个解决方法有两个引发的情况，第一，由于衬底效应的消失，那么之前提到的衬底效应使得共模输入范围变大的效应也就消失了，详情见[输入电压范围](#输入电压范围)，第二，这种方法要求了特定的衬底掺杂，因为如果时p管输入，那么就需要单独的n井，那么整体的衬底就需要为n型，可能会对其他管的选择有影响，当然还有双重井的情况，这里不讨论。

- 其他耦合

运放在整个系统中的版图绘制的互连可能会产生额外的耦合电容，这些电容本身就是电源电压，这个问题可以通过在版图上的精心绘制来尽可能避免，有一种方法就是用与地相连的金属线屏蔽运算放大器输入端。

### 过驱动电压

过驱动电压可以通过减小MOS管的漏电流与(W/L)的比值以减小，减小过驱动电压可以增大电压增益；增大输出摆幅；减小输入失调电压；增大CMRR；增大输入共模范围；增大PSRR，这些结论在MOS管工作在强反型时都是成立的。同时，增大MOS管的沟道长度，可以增大相应的厄利电压，进而增大电压增益；增大CMRR；增大PSRR。但遗憾的是，MOS管的特征频率正比于过驱动电压，反比于沟道长度的平方，因此，增大沟道长度，减小过驱动电压会导致MOS管的特征频率下降，进而影响整个运放的频率效应，这是对于运放性能的一个基础的***权衡(trade-off)***。

## 辅助放大器（Active-cascode Amp）

%这里跳过了对于cascode和folded cascode的介绍，他们是老生常谈的内容，广泛运用于各种电路，但对于他们的dc分析并不复杂，甚至可以说是简单，对于小信号分析会在以后谈到，最多也就是注意注意他们的优缺点，这里就不展开细说了，以后有机会再补吧。%

提高增益的一种方法称为辅助放大器，即通过加上辅助的放大器在放大器内部以提高增益，这一点可以参考[Active Cascode](#Active Cascode)，

<img src="E:\markdown_prj\pic\analog_ic_gray\pic_6.30.png" alt="pic_6.30" style="zoom:60%;" />

上图展示了这种电路结构，根据以前的知识可以有：
$$
R_{OUT}|_{M4A}\simeq (A_1+1)(g_{m4A}r_{o4})r_{o4A} \\
R_{OUT}|_{M2A}\simeq (A_2+1)[g_{m2A}(r_{o2}\parallel r_{o12})]r_{o2A}
$$
那么整个电路的增益则是$A_v=g_{m1}(R_{OUT}|_{M4A}\parallel R_{OUT}|_{M2A})$，根据这个结果，似乎对于另一半驱动M3A和M1A栅极的辅助放大器并不参与这个过程显得有些多余，实际上这些辅助放大器它们减少了折叠级联运算放大器的系统失调。此外，在电流镜将差分信号转换为单端信号之前，使用相同的辅助放大器驱动 M1A 和 M2A 的栅极可以平衡两个信号路径。

关于辅助放大器的选择，考虑到输入端的电压偏置大小，如M4的漏极处于$V_{DD}-V_{ovp}$的大小，如果再选择输入管为PMOS的话，可能会出现辅助放大器工作在非饱和区的情况，所以上面两个辅助放大器可以选择NMOS输入的差分对，下面两个辅助放大器可以选择PMOS输入的差分对：

<img src="E:\markdown_prj\pic\analog_ic_gray\pic_6.30(b)(c).png" alt="pic_6.30(b)(c)" style="zoom:70%;" />

同时，在将上图的b电路作为A1进行辅助时，需要注意输入与输出点的电压差，M22的输入为M4的漏极，而M22的输出为M4A的栅极，在放大的主体电路中，这两个点的电压差预计为$(|V_{tp}|+|V_{ovp}|)$，这也就意味着M22的栅漏压差也近似这个数值，也就是说M22的阈值电压需要大于这个数值才能保证M22工作在饱和区。同样的分析可以用于c图的辅助放大器。

<img src="E:\markdown_prj\pic\analog_ic_gray\pic_6.30(d).png" alt="pic_6.30(d)" style="zoom:80%;" />

上图很好的展示了该电路的偏置电路，偏置电路的设计，本身就是对主体电路MOS管的一种复制，然后该复制形成自偏置之后再去偏置主体电路，$V_{BIAS1}$代表的是输入对管的电流源的偏置，其到$V_{DD}$差不多是$|V_{tp}|+|V_{ovp}|$，而$V_{BIAS4}$则是输出支路的电流源，其到$V_{SS}$差不多是$V_{tn}+V_{ovn}$，所以在偏置电路中可以直接用二极管连接的M102和M107形成，而对于$V_{BIAS2}$和$V_{BIAS3}$其差不多是一个过驱动电压的数量级，故用处于三极管区的MOS管形成，关于这一点的计算，可以参考[Cascode Current Mirror](#Cascode Current Mirror)，可以得到一个近似关系：
$$
\left(\frac{W}{L}\right)_{106}\leq\frac{1}{3}\left(\frac{W}{L}\right)_{105} \\
\left(\frac{W}{L}\right)_{114}\leq\frac{1}{3}\left(\frac{W}{L}\right)_{113}
$$
这个电路有一个隐藏的问题，就是反馈的存在可能导致电路的不稳定，这一点也在介绍active cascode时提及了，这里依然不进行定量的分析，但提出一个可行的方案，首先我们看一看这个结构不稳定的因素，极点的存在可能威胁电路的稳定性，而在每个辅助放大器的输出节点，会有着辅助放大器自身的大的输出阻抗，而其连接至MOS管的栅极，通常情况下，MOS管的栅源电压$C_{gs}$是相较其他寄生电容较大的一部分，但在这个电路有一些不同，在这个电路中$C_{gs}$被*自举(booststrapped)*效应影响，在漏级电流恒定的情况下，源极的电压会跟随着栅极电压变化，如果栅源电压恒定，则流入栅源电容的小信号电流也为零，那么可以认为这个电容不参与这个节点的电容工作，当然实际上由于差分对会有输入，漏极的小信号变化会导致栅源电压产生变化，但自举效应仍然重要，那么根据上述的分析，在这个点，有着大的电阻，由辅助放大器提供，但电容却主要由除了$C_{gs}$外的寄生电容控制，而其他的寄生电容会受到诸多因素的影响，如工艺，温度，工作条件等等，故而在这个节点到地单独加入一个$C_c$作为补偿电容用来控制这个极点，使得电路能够稳定工作。但仍然会有一些问题，这一点以后再说。