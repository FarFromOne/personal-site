# Feedback

负反馈被广泛运用于放大器设计，其有诸多好处：

- 放大器的有源器件受PVT影响大，导致其增益变化大，反馈能有效稳定增益
- 反馈能有效调控输入与输出阻抗
- 反馈能有效减弱信号波形失真，这使其常常用于高质量的音频放大器的功率输出级
- 反馈能有效扩大带宽

但反馈也有两个缺点：

- 以上诸多好处的代价就是增益的减小，两者此消彼长
- 反馈有可能导致电路的不稳定，如振荡，稳定性是重要的设计指标

## 理想反馈

了解理想的反馈模型有助于我们对于指标和性能有着快速的认识，下图为理想的负反馈结构：

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.1.png" style="zoom:80%;" />

其中：
$$
S_o=aS_{\varepsilon} \\
S_{fb}=fS_o \\
S_{\varepsilon}=S_i-S_{fb}
$$
联立可得：
$$
\frac{S_o}{S_i}=A=\frac{a}{1+af}
$$
其中定义$A$为**闭环增益(closed-loop gain)**，定义$T=af$为**环路增益(loop gain)**，如果$T\gg 1$，那么：
$$
A\simeq \frac{1}{f}
$$
可以看到闭环增益主要由反馈系数$f$确定，常常使用稳定的无源器件作为反馈电路，那么反馈系数乃至整个电路的增益就可以得到很好的确定。

反馈回路是通过将反馈信号$S_{fb}$尽可能接近$S_i$来工作的。这由放大误差量$S_{\varepsilon}$来有效减小两者之间的误差，经由上面的关系可以得到：
$$
\frac{S_{\varepsilon}}{S_i}=\frac{1}{1+af}=\frac{1}{1+T}
$$
如果环路增益$T$远大于1，那么这个误差量就远小于输入信号，当然也有：
$$
\frac{S_{fb}}{S_i}=\frac{T}{1+T}
$$
当$T$远大于1，那么可以认为$S_{fb}$是$S_i$的复制，又由于$S_{fb}=fS_{o}$，那么考虑$|f|<1$，则输出就是输入的放大，这就是反馈放大器的工作原理。

## 增益灵敏度

正向放大器（或者前馈放大器，基础放大器）的增益$a$受诸多因素影响，正如前面所说，反馈使得整体的增益受$a$的影响变小，这个关系可以这样考虑：
$$
\frac{dA}{da}=\frac{1+af-af}{(1+af)^2} \\
\frac{dA}{da}=\frac{1}{(1+af)^2}
$$
取$a$的小量$\delta a$，可得：
$$
\delta A=\frac{\delta a}{(1+af)^2}
$$
那么$A$的分式变化为：
$$
\frac{\delta A}{A}=\frac{1+af}{a}\frac{\delta a}{(1+af)^2} \\
\frac{\delta A}{A}=\frac{\frac{\delta a}{a}}{1+af}
$$
那么可得$A$的灵敏度是$a$的$1+af$分之一倍，也就是说，当$T=100$，$a$受PVT变化了10%，则$A$变化仅0.1%。

## 失真减弱

前文提及对于增益的敏感度，电路有着维持增益$A$尽可能不变化的能力，那么可以思考是否对于失真也有一定的抵抗能力，假如前馈放大器是一个非线性的放大器，其输入输出曲线如下：

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.2.png" style="zoom:70%;" />

那么根据反馈的传输公式$A=\frac{a}{1+af}$，对于不同的前馈放大系数（开环增益，open-loop gain）$a$，也有不同的闭环增益$A$，可以得到下图的关系：

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.3.png" style="zoom:70%;" />

可以明显看出电路增益的非线性度减弱了。

需要注意的是，下面的闭环增益的坐标是进行了一定的放缩以便于与开环增益进行比较，可以看到这是由于增益下降$(1+T)$倍导致的尺寸变化，不过增益的变小其实问题不大，因为可以通过加入预放大器(preamplifer)在反馈放大器之前来解决，由于预放大器的输入信号幅度都较小，故失真对预放大器并不是什么问题。

还有需要注意的是由于输入输出信号过大出现的硬失真，即$a_3=0,A_3=0$的区域，此时输出完全不由输入控制。

> 在观察两个转移曲线时有一个小问题，在$a_2$到$a_3$的转折点此时的输入信号$S_{i2}=\frac{S_{o1}}{a_1}+\frac{S_{o2}-S_{o1}}{a_2}$，大于这个信号大小之后前馈放大器$a$进入硬饱和使得$a_3=0$，在反馈的转移曲线中，$A_2$到$A_3$的转折点的输入信号$S_{i2'}=\frac{S_{o1}}{a_1}(1+a_1f)+\frac{S_{o2}-S_{o1}}{a_2}(1+a_2f)$，大于这个信号$A$进入硬饱和使得$A_3=0$，那么当输入信号介于$S_{i2}$和$S_{i2'}$之间时为什么不会由于$a$饱和导致$A$也饱和而必须在大于$S_{i2'}$之后$A$才饱和呢，实际上在输入信号介于$S_{i2}$和$S_{i2'}$之间$a$并不会饱和，因为8.2所绘制的是前馈放大器的输入输出转移曲线，并不是反馈电路的输入输出转移曲线，在反馈电路中的前馈放大器的输入是$S_{i}-S_{fb}$，由于反馈信号是对于输入信号的复制，所以此时前馈放大器输入的大小并不会使得$a$饱和

## 反馈架构

在实际电路中，电压和电流作为输入输出以及反馈信号作用于之前提及的反馈环路中，根据输出信号$S_o$为电流还是电压以及反馈信号$S_{fb}$是电流还是电压可以分为四种反馈架构

### 串联-并联反馈 Series-Shunt Feedback

对于一个输入电压输出电压的反馈放大器（所以也称为电压-电压反馈），需要将输出电压进行采样反馈到输入电压，如下图所示

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.4.png" style="zoom:80%;" />

理想情况下，反馈网络的输入$z_{22f}=\infty$，也就是不会对前馈放大器产生负载，并且对输出电压是并联进行采样，而反馈网络的输出$v_{fb}$与输入进行串联进而和输入进行比较，理想情况下反馈网络的输出阻抗$z_{11f}=0$，也就是不会对反馈信号$v_{fb}$产生分压，同时前馈放大器和反馈网络都是单边的（unilateral），即前馈放大器仅有误差量$v_{\epsilon}$转移到$v_o$，不会反向传播，反馈网络也只有输出$v_o$传播到$v_{fb}$，不会反向传播。

这个电路架构之所以叫串联-并联反馈是因为反馈网络与输入串联，与输出并联，叫电压-电压反馈是因为它检测输出电压，反馈回一个电压。

由上图8.4可以得到：
$$
\frac{v_o}{v_i}=\frac{a}{1+af}
$$
这是基于理想条件的情况，假设输入源存在一个源电阻$z_s$如下图所示

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.5.png" style="zoom:67%;" />

输入输出的关系$v_o/v_i$仍然和之前一样，只是其中的$v_i=\frac{Z_i}{Z_i+z_s}v_s$，其中的$Z_i$是$v_i$看进电路的阻抗，假如$z_s\approx Z_i$，那么输入$v_i$取决于$Z_i$而这个值常常由有源器件决定，会导致$v_o/v_s$的不稳定，所以总而言之，为了稳定增益，输入串联并联架构的反馈放大器的源阻抗最好小于闭环放大器的输入阻抗，最理想的情况驱动源是电压源。

接下来考虑该架构的端口阻抗，

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.6.png" style="zoom:67%;" />

其中$z_i$为前馈放大器的输入阻抗，$z_o$为前馈放大器的输出阻抗，仍然保留前馈放大器和反馈网络的单边特性，

不展开计算输入阻抗，简单而言，由于反馈信号的存在，使得在$z_i$上的压降从$v_i$下降到$v_{\epsilon}$，进而减小了流入的电流，结果在整体输入仍为$v_i$时，输入的阻抗放大了$(1+T)$倍，即
$$
Z_i=\frac{v_i}{i_i}=(1+T)z_i
$$
输入的串联反馈总是使得输入阻抗提升$(1+T)$倍

输出阻抗的计算如下图所示，将输入$v_i$置零即短接，在输出加一个电压$v$：

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.7.png" style="zoom:80%;" />

仍然不展开计算，由于输出端的电压$v$被反馈回路采样再反向叠加在前馈的输出$av_{\epsilon}=-afv$，导致输出端的流入电流增大，进而使输出端的阻抗减小$(1+T)$倍，即
$$
Z_o=\frac{v}{i}=\frac{z_o}{1+T}
$$
在输出端的并联反馈总是使得输出阻抗减小$(1+T)$倍。这也使得串联-并联反馈成为一个很好的电压放大器，因为它稳定了增益，增大了输入阻抗，减小了输出阻抗。

串联-并联反馈架构可以用下图的等效电路表示，当前馈放大器的增益为无穷大时转为图b，变为一个理想的电压放大器

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.8.png" style="zoom:80%;" />

### 并联-并联反馈 Shunt-Shunt Feedback

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.9.png" style="zoom:67%;" />

并联-并联反馈也称电压-电流反馈，其通过并联输出采样输出电压作为反馈输入，所以理想情况下的反馈输入阻抗和之前一样$z_{22f}=\infty$，而反馈输出是通过并联分流输入电流，其分流量为$fv_o$，理想情况下反馈的输入阻抗$z_{11f}=\infty$，也就是说反馈网络不产生并联负载导致的分流在放大器的输入。

根据简单的运算可得理想的闭环增益：
$$
\frac{v_o}{i_i}=\frac{a}{1+af}=A
$$
注意到这里面的$a$具有电阻的量纲，$f$具有跨导的量纲。而环路增益$T=af$则是无量纲，这一点是普适的特性。

在这个架构中，假设和输入电流源并联的源阻抗$z_{s}$是有限值，会导致其与放大器输入之间的分流，也就是$i_i=\frac{z_s}{z_s+Z_{in}}i_{s}$，那么这个分流就会导致增益的不稳定，所以这种架构最好是$z_s\gg Z_{in}$，也就是输入理想的电流源驱动。

根据电路可以得到：
$$
i_{\epsilon}=\frac{i_i}{1+af} \\
Z_i=\frac{v_i}{i_i} \\
Z_i=\frac{v_i}{i_{\epsilon}}\frac{1}{1+af}=\frac{z_i}{1+T}
$$
故在输入的并联反馈回减小放大器输入的阻抗$(1+T)$倍，这是一个通用结论

输出阻抗也可以简单得到：
$$
Z_o=\frac{z_o}{1+T}
$$
这和之前输出并联反馈的输出阻抗一样。

输入阻抗的减小和输出阻抗的减小使得这个架构成为一个良好的跨阻放大器。其等效模型如下图，当前馈放大器$a$趋于无穷时，演变为b图，表现为理想跨阻放大器

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.10.png" style="zoom:60%;" />

### 并联-串联反馈 Shunt-Series Feedback

也称为电流-电流反馈，这种架构在输出端串联检测输出电流进入反馈网络，在输入端并联加入反馈输出电流，和并联-并联反馈的输入一样，源电阻的存在会使电流分流进而导致增益不稳定，最好的输入源是具有无穷大阻抗的电流源驱动。

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.11.png" style="zoom:67%;" />

其基本特性如下：
$$
\frac{i_o}{i_i}=\frac{a}{1+af} \\
Z_i=\frac{z_i}{1+T} \\
Z_o=z_o(1+T)
$$
这个架构是一个好的电流放大器，其具有稳定的电流增益，低输入阻抗，高输出阻抗

### 串联-串联反馈 Series-Series Feedback

也称为电流-电压反馈，其在输出串联检测电流进入反馈网络，在输入串联反馈输出电压进行误差值产生，如串联-并联反馈类似，源电压的存在会导致输入电压的分压，使得增益不稳定，故最好是低源阻抗的驱动源，理想情况是电压源。

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.12.png" style="zoom:67%;" />

其基本特性如下：
$$
\frac{i_o}{v_i}=\frac{a}{1+af} \\
Z_i=z_i(1+T) \\
Z_o=z_o(1+T)
$$
故该架构是良好的跨导放大器，具有稳定的跨导增益，以及高的输入输出阻抗。

## 加载效应

在实际的反馈放大器中，反馈网络会在基本放大器的输入和输出端造成负载，因此基本放大器和反馈网络的划分并不像上述处理方法所提及的那样明显。由于反馈网络本身导致前馈电路的输入阻抗和输出阻抗乃至整个电路性能（包括频率响应）收到影响的效应叫加载效应。

其实关于加载效应只需要了解上面那段话就可以了，这听上去很荒谬，但在分析实际电路的时候会遇到以下情况：

- 反馈网络并不明显，难以区分哪一部分属于前馈，哪一部分属于反馈
- 电路难以归类到之前的四种标准反馈类型中，也就是反馈类型并不标准
- 多条反馈回路使得分析变得困难

以上两点使得单纯的理想电路分析几乎不可能，而原本在本节用于解决加载效应的二端口网络法，其本质是**将反馈网络等效到前馈网络的一部分，对开环增益进行修正，再同时使反馈网络理想化**，这样一来就可以得到闭环增益$\frac{a_{cal}}{1+fa_{cal}}$，但这会引入非常致命的问题：

- 该方法忽略了前馈和反馈各自的反馈通路和前馈通路，即在信号流向的角度进行了理想化
- 对于非标准的反馈结构变得异常棘手甚至无法分析
- 对于多反馈回路无法分析

所以这里只进行方法的记忆理解，真正的二端口网络分析细节可以参考Gary的书相应章节，真正的解决反馈方法会放在后面的Middlebrook方法和Blackman方法中。

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.67_r.png" style="zoom:80%;" />

上图给出了四种标准反馈的加载效应中的开环等效电路，也就是先通过上图的等效得到开环增益$A_{OL}$，再由反馈系数$f$，得到比例因子$1+A_{OL}f$进而得到输入输出阻抗以及闭环增益。

接下来讲述如何记忆这些等效

> 以下部分图源于知乎@混分巨兽，大佬的图清晰明了，可以阅读其有关的文章“All About Circuits——加载效应的直观理解 Loading Effect with an Intuitive Approach”

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8_1_hfjs..jpg" style="zoom:40%;" />

如上图所示，加载效应的等效是在输入和输出各自加入一个反馈网络，而关键区别在于根据不同的反馈类型决定等效的反馈网络的另一端是开路还是短路。

正如上图所示，另一端接的什么是由没有与之连接运放的一端连接决定的：

以串联-并联反馈为例（即电压-电压反馈）：

![](E:\personal-site\notes-md\pic\analog_ic_gray\pic_8_1_m.png)

在考虑输入的负载，即连接到反馈网络的另一端连接地还是开路时，再往前一节观察前馈放大器的输出阻抗：对于串联-并联反馈其输出阻抗理想为0，那么这里的反馈网络另一端连接地：

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8_2_m.png" style="zoom:60%;" />

对于输出端的加载，则是观察输入端的阻抗情况：

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8_3_m.png" style="zoom:60%;" />

由于串联-并联反馈的理想输入阻抗是无穷大，所以输出端的反馈网络加载的另一端开路：

<img src="E:\personal-site\notes-md\pic\analog_ic_gray\pic_8_4_m.png" style="zoom:60%;" />

那么我们可以得到串联-并联反馈在加载效应等效下的开环电路图：

![](E:\personal-site\notes-md\pic\analog_ic_gray\pic_8.53_r.png)

其余的三种架构也可以用类似的方法得到，这里不再赘述。

也许会想到米勒效应，其也是通过在输入输出等效其米勒电容乘一个系数，但两者有一个巨大的区别，加载效应是等效之后对于开环增益的修正并不是闭环增益，同时将反馈理想化，而米勒效应则是对闭环特性的近似，不过就实际分析而言，它们都忽略了信号的额外前馈流动，比如加载效应忽略了反馈网络的前馈效应，米勒效应断开的电容也忽略了前馈通路，导致两者都会忽略一部分电路特性，比如零点。

除此之外，根据前馈的端口阻抗来判断加载的连接是很不可控的，因为实际电路并不是零或者无穷大阻抗，同时对于一些非显式的反馈，如退化的共源级，其输出由一个电阻连接至源极与退化电阻之间，这个反馈通过$V_{gs}$的差值实现电压相减，那么在计算输出的负载时其观察的前馈输入阻抗应该是无穷大，但实际上从源极观察进去是 $1/g_m$，很明显这并不大。

> 顺带吐槽一下Gary计算反馈系数的方法，在反馈网络输入一个信号然后看它输出的信号比值，虽然确实很贴合四种基础反馈架构，但实际上分析反馈网络最大的一个问题之一就是分辨哪一部分是反馈网络。